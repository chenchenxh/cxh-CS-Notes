## DNS

首先，浏览器向本地 DNS 服务器发起请求，由于本地 DNS 服务器没有缓存不能直接将域名转换为 IP 地址，需要采用递归或者迭代查询的方式（图 3）依次向根域名服务器、顶级域名服务器、权威域名服务器发起查询请求，直至找到一个或一组 IP 地址，返回给浏览器。

## SSL（HTTPS）

### TLS四次握手（传输公钥）

如果客户端此前未与服务器建立会话，那么双方需要进行一次完整的 TLS 四次握手。

1. **客户端首先向服务器发送 Client Hello 报文**，包含一个随机数、TLS 协议版本、按优先级排列的加密套件列表。
2. **服务器向客户端发送 Server Hello 报文**，包含一个新的随机数、TLS 协议版本、经过选择后的一个加密套件。
3. **服务器向客户端发送 Certificate 报文**，包含服务器 X.509 证书链，其中，第一个为主证书，中间证书按照顺序跟在主证书之后，而根 CA 证书通常内置在操作系统或浏览器中，无需服务器发送。
   - 如果密钥交换选择 DH 算法，服务器会向客户端发送 Server Key Exchange 报文，包含密钥交换所需的 DH 参数；如果密钥交换选择 RSA 算法，则跳过这一步。
4. **服务器向客户端发送 Server Hello Done 报文**，表明已经发送完所有握手消息。

### 交换对称算法

1. **客户端向服务器发送 Client Key Exchange 报文**，如果密钥交换选择 RSA 算法，由客户端生成预主密钥，**使用服务器证书中的公钥对其加密**，包含在报文中，服务器只需使用自己的私钥解密就可以取出预主密钥；如果密钥交换选择 DH 算法，客户端会在报文中包含自己的 DH 参数，之后双方都根据 DH 算法计算出相同的预主密钥。需要注意的是，密钥交换的只是预主密钥，这个值还需进一步加工，**结合客户端和服务器两个随机数种子，双方使用 PRF（pseudorandom function，伪随机函数）生成相同的主密钥**。
2. **客户端向服务器发送 Change Cipher Spec 报文，表明已经生成主密钥**，在随后的传输过程都使用这个主密钥对消息进行对称加密。
3. **客户端向服务器发送 Finished 报文，这条消息是经过加密的**，因此在 Wireshark 中显示的是 Encrypted Handshake Message。如果服务器能解密出报文内容，则说明双方生成的主密钥是一致的。
4. **服务器向客户端发送 New Session Ticket 报文**，而这个 Session Ticket 只有服务器才能解密，客户端把它保存下来，在以后的 TLS 重新握手过程中带上它进行快速会话恢复，减少往返延迟。
5. **服务器向客户端发送 Finished 报文**，如果客户端能解密出报文内容，则说明双方生成的主密钥是一致的。至此，完成所有握手协商。

## TCP

TCP三次握手

TCP四次挥手（先关闭方最后等待2MSL（最大报文生成时间））

## HTTP请求

请求行，请求头，空行，请求体

## 浏览器解析

渲染页面